# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project

Personal portfolio/project showcase website for dwk.io, built with Eleventy (11ty) v3 using TypeScript, ES modules, and WebC components. Deployed as a Cloudflare Worker with Static Assets.

## Commands

- `npm run start` — Eleventy dev server with live reload
- `npm run build` — Production build (outputs to `_site/`)
- `npm run postbuild` — Adds SRI hashes to CSS/JS assets and signs security.txt (runs automatically after build)
- `npm run typecheck` — Type check both Eleventy and Worker code
- `npm run dev:worker` — Local Wrangler dev server (Workers + static assets)
- `npm run deploy` — Build and deploy to Cloudflare Workers
- `npm run cf-typegen` — Regenerate `worker-configuration.d.ts` types
- `npm test` — Run Worker tests (Vitest + `@cloudflare/vitest-pool-workers`)
- `npm run test:watch` — Run tests in watch mode

## Architecture

**TypeScript:** All build-time code is TypeScript. Node 22's `--experimental-strip-types` handles type erasure at runtime. Strict mode enabled via `tsconfig.json`. Shared types in `src/types.ts`, ambient declarations for untyped packages in `src/ambient.d.ts`. Worker code has a separate `worker/tsconfig.json` targeting Cloudflare Workers runtime types (generated by `wrangler types` into `worker-configuration.d.ts`).

**Eleventy config:** `eleventy.config.ts` — source is `src/`, output is `_site/`, includes are `_includes/`, layouts are `_layouts/`. Template engines: WebC for HTML/Markdown, plus `.11ty.ts` (registered via `addExtension("11ty.ts", { key: "11ty.js" })`). Data files use `.ts` extension (registered via `addDataExtension("ts", ...)`).

**Content pipeline:**
1. WebC/Markdown templates processed by Eleventy
2. Images optimized to WebP + JPEG via `@11ty/eleventy-img`
3. Markdown images are intercepted and routed through the `image` shortcode (custom markdown-it renderer override)
4. HTML minified via `html-minifier-terser` transform
5. Post-build: `scripts/postbuild.ts` adds SHA-384 SRI integrity attributes to local CSS/JS using cheerio, and signs security.txt with OpenPGP

**Global data** (`src/_data/`):
- `site.ts` — Site metadata (title, URL, social links, favicon config, identity endpoints)
- `navigation.ts` — Nav menu items
- `schema.ts` — Schema.org Person JSON-LD template

**Layouts** (`src/_layouts/`):
- `base.webc` — Root HTML document structure
- `project.webc` — Project detail pages

**Components** (`src/_includes/`):
- `main.css` / `main.js` — Global bundled styles and scripts (main.js is client-side browser JS, not TypeScript)
- `head-meta.webc`, `head-link.webc`, `head-js.webc` — Document head partials
- `custom/header.webc`, `custom/footer.webc` — Site chrome

**Projects** live in `src/projects/<name>/` with an `index.md` and assets. Shared front matter is in `src/projects/projects.11tydata.ts` (sets layout, tags, schema type).

**Worker** (`worker/index.ts`): Cloudflare Worker that handles redirects, fetches static assets via `env.ASSETS.fetch()`, and applies custom response headers. Configured in `wrangler.jsonc` with `run_worker_first: true` so all requests pass through the Worker. Replaces the former `_headers` and `_redirects` Cloudflare Pages config files.

**Generated files** in `src/`: `feed.json.11ty.ts` produces JSON Feed; `feed.xml.11ty.ts` produces Atom feed; `.well-known/` templates produce identity/discovery endpoints; `sitemap.xml.webc`, `robots.txt.webc`, `humans.txt.webc` produce standard web files.

**IndieWeb:** Homepage has a representative `h-card` (microformats2 identity) and `h-feed` wrapper. Project pages use `h-entry` markup. IndieAuth (`indieauth.com`) and Webmention (`webmention.io`) endpoints are advertised in `<head>` via `site.ts` headLinks. Homepage schema is `ProfilePage` with `mainEntity` (via `index.11tydata.ts` override).

## Key Conventions

- `setFreezeReservedData(false)` is set as a workaround for eleventy-plugin-webc issue #86 — when using dynamic permalinks in WebC, duplicate the permalink value in `page.url` front matter.
- Schema.org JSON-LD is validated at build time via `jsonld-lint` — invalid schema will fail the build.
- Images require alt text; missing alt logs a warning.
- 1990s retro theme: monospace typography (Courier New), silver/gray light mode, dark cyan/blue dark mode. Both modes supported via `prefers-color-scheme`.
- Use `.11ty.ts` templates (not `.webc`) for JSON, XML, and plain-text outputs to avoid WebC HTML processing/escaping issues.
- Extensionless outputs (e.g., `webfinger`, `host-meta`) require `eleventyAllowMissingExtension: true` in front matter data.
